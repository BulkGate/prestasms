{% extends '@!PrestaShop/Admin/layout.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script async src="//localhost:81/widget/eshop/load/{{ token }}/?config=init_widget_eshop_load"></script>
    <script>
        function init_widget_eshop_load(widget) {
            function getHeaders(token) {
                return function () {
                    return {
                        Authorization: "Bearer " + token
                    }
                }
            }

            widget.authenticator = {
                getHeaders: getHeaders("{{ token }}"),
                setToken: (token) => {
                    widget.authenticator.getHeaders = getHeaders(token);
                },
                authenticate: async () => {
                    let response = await fetch("{{ path("bulkgate_proxy", {action: "authenticate"}) }}", {
                        method: "POST",
                    });
                    let {token, redirect} = await response.json();

                    if (redirect) {
                        return {redirect};
                    }
                    if (token) {
                        widget.authenticator.getHeaders = getHeaders(token);
                    }

                    return {};
                }
            };

            widget.merge({
                layout: {
                    links: {
                        homepage: "/homepage"
                    },
                    server: {
                        application: {}, {# $escape_js($application)} #}
                        application_settings: {}, {# $escape_js($plugin_settings) #}
                    },
                    // static (dictionary) for frontend form
                    scope: {
                        application_settings: {
                            dispatcher: {cron: "dispatcher_cron", asset: "dispatcher_asset", direct: "dispatcher_direct"},
                            synchronization: {
                                all: "synchronization_all",
                                message: "synchronization_message",
                                off: "synchronization_off"
                            },
                            address_preference: {
                                delivery: "address_preference_delivery",
                                invoice: "address_preference_invoice"
                            },
                        }
                    }
                }
            });

            widget.events.onComputeHostLayout = (compute) => {
                let hostAppBar = document.getElementById("wpadminbar");
                let hostNavBar = document.getElementById("adminmenuback");
                let hostRootWrap = document.getElementById("bulkgate-plugin");

                compute({appBar: hostAppBar, navBar: hostNavBar});

                if (hostRootWrap.parentElement.id === "wpbody-content") { // woosms-module page, otherwise eg. send-sms widget
                    let style = getComputedStyle(document.getElementById("wpcontent"));
                    hostRootWrap.style.setProperty("--bulkgate-plugin-body-indent", style.getPropertyValue("padding-left"));
                }
            };

            widget.options.theme = {
                components: {
                    BulkGateSignInView: {
                        defaultProps: {
                            showLanguagePanel: false,
                            showPermanentLogin: false,
                            logo: "images/white-label/bulkgate/logo/logo-title.svg",
                            logo_dark: "images/white-label/bulkgate/logo/logo-white.svg",
                            background: "images/products/backgrounds/ws.svg"
                        }
                    },
                    BulkGateSignUpView: {
                        defaultProps: {
                            showLanguagePanel: false,
                            logo: "images/white-label/bulkgate/logo/logo-title.svg",
                            logo_dark: "images/white-label/bulkgate/logo/logo-white.svg",
                            background: "images/products/backgrounds/ws.svg"
                        }
                    }
                }
            };

            widget.options.layout = {
                appBar: {
                    showLogOut: false,
                    logoUrl: "images/white-label/bulkgate/logo/logo-title.svg",
                    logoStyle: {
                        height: "28px",
                        width: "192px",
                    }
                }
            };

            widget.options.proxy = function (reducerName, requestData) {
                let proxyData = {
                    PROXY_LOG_IN: {
                        url: "{{ path("bulkgate_proxy", {action: "login"}) }}",
                    },
                    PROXY_LOG_OUT: {
                        url: "{{ path("bulkgate_proxy", {action: "logout"}) }}",
                    },
                    PROXY_SAVE_MODULE_SETTINGS: {
                        url: "{{ path("bulkgate_proxy", {action: "module-settings"}) }}",
                    }
                };
                let {url, params} = proxyData[requestData.actionType] || {};

                if (url) {
                    requestData.contentType = "application/x-www-form-urlencoded";
                    requestData.url = url;
                    requestData.data = {__bulkgate: requestData.data, ...params};
                    return true;
                }

                try {
                    // relative -> absolute url conversion. In modules context, relative urls are not suitable. This covers routing (soft redirects change route) and signals (actions).
                    let baseUrl = new URL("http://localhost:81"); // bulkgate's app url
                    url = new URL(requestData.url, baseUrl);
                    requestData.url = url.toString();
                    return true;
                } catch {
                }
            };

            // loading management
            function handleViewRender(ev) {
                const loading = document.querySelector("#bulkgate-plugin #loading");
                loading.style.display = "none";

                //remove handler after hide loader
                window.removeEventListener("gate-view-render", handleViewRender);
            }

            window.addEventListener("gate-view-render", handleViewRender);
        }
    </script>
{% endblock %}

{% block stylesheets %}
    <style>
        @keyframes logo {
            0% {
                filter: grayscale(1) opacity(.2);
                transform: scale(.6);
            }
            25% {
                filter: none;
                transform: scale(.65);
            }
            70% {
                transform: none;
            }
        }

        @keyframes heading {
            0% {
                opacity: .1;
            }
            50% {
                opacity: .8;
            }
            100% {
                opacity: 1;
            }
        }

        @keyframes progress {
            100% {
                opacity: 1
            }
        }

        @keyframes progress-processing {
            0% {
                transform: translateX(-300px)
            }
            5% {
                transform: translateX(-240px)
            }
            15% {
                transform: translateX(-30px)
            }
            25% {
                transform: translateX(-30px)
            }
            30% {
                transform: translateX(-20px)
            }
            45% {
                transform: translateX(-20px)
            }
            50% {
                transform: translateX(-15px)
            }
            65% {
                transform: translateX(-15px)
            }
            70% {
                transform: translateX(-10px)
            }
            95% {
                transform: translateX(-10px)
            }
            100% {
                transform: translateX(-5px)
            }
        }

        #bulkgate-plugin {
            position: relative;
            z-index: 0;
            margin-left: calc(var(--bulkgate-plugin-body-indent, 0) * -1);
        }

        #bulkgate-plugin #loading {
            position: fixed;
            contain: layout;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2999;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #bulkgate-plugin #loading img {
            width: 160px;
            animation: logo 1.5s .3s both;
            margin: 24px 0;
        }

        #bulkgate-plugin #loading h3 {
            font-size: 32px;
            color: #606469;
            animation: heading .5s .675s both;
        }

        #bulkgate-plugin #progress {
            animation: progress .5s 2.5s 1 both;
            height: 4px;
            width: 100%;
            opacity: 0;
            background: #ddd;
            position: relative;
            overflow: hidden;
        }

        #bulkgate-plugin #progress:before {
            animation: progress-processing 20s 3s linear both;
            background-color: var(--secondary);
            content: '';
            display: block;
            height: 100%;
            position: absolute;
            transform: translateX(-300px);
            width: 100%;
        }

        gate-ecommerce-plugin {
            box-sizing: border-box; /* realne se tyka pouze web-componenty */
        }
    </style>
{% endblock %}

{% block content %}
    <div id="bulkgate-plugin" style="--primary: #25b9d7; --secondary: #e50a70;">
        <gate-ecommerce-plugin data-theme='{"palette": {"mode": "light", "background": {"default": "#f1f1f1"}}}'></gate-ecommerce-plugin>
        <div id="loading">
            <div>
                <img src="//localhost:81/images/white-label/bulkgate/logo/short.svg" alt="BulkGate" />
                <div id="progress"></div>
            </div>
        </div>
    </div>
{% endblock %}